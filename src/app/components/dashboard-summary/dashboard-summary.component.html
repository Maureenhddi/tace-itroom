<div class="dashboard-container">
  <!-- Panneau d'alertes -->
  <app-alerts-panel [monthlySummaries]="monthlySummaries"></app-alerts-panel>

  <div class="dashboard-header">
    <h2 class="dashboard-title">Résumé des Taux d'Activité par Mois</h2>
    <button mat-raised-button color="primary" (click)="exportToExcel()" class="export-button">
      <mat-icon>file_download</mat-icon>
      Exporter Excel
    </button>
  </div>
  <div class="summary-grid">
    @for (summary of monthlySummaries; track summary.month) {
      <mat-card class="month-card">
        <mat-card-header>
          <mat-card-title>{{ summary.month }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Taux totaux -->
          <div class="metric-section total-section">
            <h3 class="section-title">Global</h3>
            <div class="metrics-row">
              <div class="metric-item total-real" [ngClass]="getRateClass(summary.totalMetrics.realRate)">
                <span class="metric-label">Taux réel</span>
                <span class="metric-value">{{ summary.totalMetrics.realRate }}%</span>
                @if (summary.trends && summary.trends.realRateTrend !== undefined) {
                  <span class="metric-trend" [ngClass]="getTrendClass(summary.trends.realRateTrend)" [matTooltip]="'Évolution vs mois précédent'">
                    <mat-icon>{{ getTrendIcon(summary.trends.realRateTrend) }}</mat-icon>
                    {{ formatTrend(summary.trends.realRateTrend) }}
                  </span>
                }
              </div>
              <div class="metric-item total-estimated" [ngClass]="getRateClass(summary.totalMetrics.estimatedRate)">
                <span class="metric-label">Taux estimé</span>
                <span class="metric-value">{{ summary.totalMetrics.estimatedRate }}%</span>
                @if (summary.trends && summary.trends.estimatedRateTrend !== undefined) {
                  <span class="metric-trend" [ngClass]="getTrendClass(summary.trends.estimatedRateTrend)" [matTooltip]="'Évolution vs mois précédent'">
                    <mat-icon>{{ getTrendIcon(summary.trends.estimatedRateTrend) }}</mat-icon>
                    {{ formatTrend(summary.trends.estimatedRateTrend) }}
                  </span>
                }
              </div>
            </div>
          </div>

          <!-- Taux par équipe spécifique -->
          <div class="metric-section">
            <h3 class="section-title">Taux Réel par Équipe</h3>
            <div class="metrics-grid">
              <div class="metric-item team-front-ecommerce" [ngClass]="getRateClass(summary.specificTeamMetrics.frontEcommerceRate)">
                <span class="metric-label">Front E-commerce</span>
                <span class="metric-value">{{ summary.specificTeamMetrics.frontEcommerceRate }}%</span>
                @if (summary.trends && summary.trends.frontEcommerceTrend !== undefined) {
                  <span class="metric-trend" [ngClass]="getTrendClass(summary.trends.frontEcommerceTrend)">
                    <mat-icon>{{ getTrendIcon(summary.trends.frontEcommerceTrend) }}</mat-icon>
                    {{ formatTrend(summary.trends.frontEcommerceTrend) }}
                  </span>
                }
              </div>
              <div class="metric-item team-back-ecommerce" [ngClass]="getRateClass(summary.specificTeamMetrics.backEcommerceRate)">
                <span class="metric-label">Back E-commerce</span>
                <span class="metric-value">{{ summary.specificTeamMetrics.backEcommerceRate }}%</span>
                @if (summary.trends && summary.trends.backEcommerceTrend !== undefined) {
                  <span class="metric-trend" [ngClass]="getTrendClass(summary.trends.backEcommerceTrend)">
                    <mat-icon>{{ getTrendIcon(summary.trends.backEcommerceTrend) }}</mat-icon>
                    {{ formatTrend(summary.trends.backEcommerceTrend) }}
                  </span>
                }
              </div>
              <div class="metric-item team-front-surmesure" [ngClass]="getRateClass(summary.specificTeamMetrics.frontSurMesureRate)">
                <span class="metric-label">Front Sur mesure</span>
                <span class="metric-value">{{ summary.specificTeamMetrics.frontSurMesureRate }}%</span>
                @if (summary.trends && summary.trends.frontSurMesureTrend !== undefined) {
                  <span class="metric-trend" [ngClass]="getTrendClass(summary.trends.frontSurMesureTrend)">
                    <mat-icon>{{ getTrendIcon(summary.trends.frontSurMesureTrend) }}</mat-icon>
                    {{ formatTrend(summary.trends.frontSurMesureTrend) }}
                  </span>
                }
              </div>
              <div class="metric-item team-back-surmesure" [ngClass]="getRateClass(summary.specificTeamMetrics.backSurMesureRate)">
                <span class="metric-label">Back Sur mesure</span>
                <span class="metric-value">{{ summary.specificTeamMetrics.backSurMesureRate }}%</span>
                @if (summary.trends && summary.trends.backSurMesureTrend !== undefined) {
                  <span class="metric-trend" [ngClass]="getTrendClass(summary.trends.backSurMesureTrend)">
                    <mat-icon>{{ getTrendIcon(summary.trends.backSurMesureTrend) }}</mat-icon>
                    {{ formatTrend(summary.trends.backSurMesureTrend) }}
                  </span>
                }
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- Graphiques consolidés du taux d'activité réel des équipes -->
  @if (consolidatedDailyMetrics.length > 0) {
    <div class="consolidated-charts-section">
      <h2 class="section-title">Taux d'Activité Réel des Équipes (Tous les mois)</h2>

      <app-activity-chart
        [dailyMetrics]="consolidatedDailyMetrics"
        [chartType]="'expertise'"
        [title]="'Taux d\'activité réel - E-commerce vs Sur mesure'">
      </app-activity-chart>

      <app-activity-chart
        [dailyMetrics]="consolidatedDailyMetrics"
        [chartType]="'ecommerce-teams'"
        [title]="'Taux d\'activité réel E-commerce - Front vs Back'">
      </app-activity-chart>

      <app-activity-chart
        [dailyMetrics]="consolidatedDailyMetrics"
        [chartType]="'surmesure-teams'"
        [title]="'Taux d\'activité réel Sur mesure - Front vs Back'">
      </app-activity-chart>
    </div>
  }

</div>
